<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RaVa AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Inter', sans-serif; background-color: #0a0a0a; color: #E5E7EB; }
        #app-root { height: 100%; }
        #app-view, #admin-view-container, #login-view, #pricing-view { height: 100%; max-height: -webkit-fill-available; }
        #space-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: #0a0a0a; overflow: hidden; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .bg-blurry { background-color: rgba(10, 10, 10, 0); } /* FULLY TRANSPARENT */
        .chat-container::-webkit-scrollbar { width: 6px; }
        .chat-container::-webkit-scrollbar-thumb { background-color: #4a5568; border-radius: 20px; }
        .ai-message-content p, .ai-message-content li, .ai-message-content h1 { margin-bottom: 0.75rem; }
        .ai-message-content code { background-color: rgba(26,32,44,0.7); border: 1px solid #2d3748; padding: 0.2rem 0.4rem; border-radius: 4px; font-family: monospace; word-break: break-all; }
        .ai-message-content pre { background-color: rgba(26,32,44,0.7); border: 1px solid #2d3748; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; overflow-x: auto; }
        .glowing-border { position: relative; border: 1px solid #374151; transition: box-shadow 0.3s ease-in-out; overflow: hidden; }
        .glowing-border:focus-within { border-color: #818cf8; }
        .glowing-border::after { content: ''; position: absolute; bottom: 0; left: -50%; width: 200%; height: 3px; background: linear-gradient(90deg, transparent, #6366f1, #ec4899, #38bdf8, transparent); animation: move-light 4s linear infinite; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .glowing-border:focus-within::after { opacity: 1; }
        @keyframes move-light { 0% { transform: translateX(0); } 100% { transform: translateX(25%); } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .chat-message { animation: slideInUp 0.5s ease-out forwards; }
        .thinking-box { position: relative; padding: 1rem; border-radius: 0.75rem; background-color: rgba(31, 41, 55, 0.5); overflow: hidden; }
        .thinking-box::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: conic-gradient(transparent, rgba(139, 92, 246, 0.8), transparent 30%); animation: rotate 4s linear infinite; }
        @keyframes rotate { 100% { transform: rotate(360deg); } }
        .thinking-box-content { position: relative; z-index: 1; }
    </style>
</head>
<body class="antialiased">
    
    <canvas id="space-bg"></canvas>

    <div id="app-root" class="w-full flex flex-col items-center justify-center">

        <div id="login-view" class="w-full h-full flex items-center justify-center hidden p-4">
             <div class="w-full max-w-md bg-slate-900/50 backdrop-blur-xl border border-slate-700 rounded-2xl p-6 sm:p-8 shadow-2xl shadow-indigo-500/10">
                <h1 class="text-3xl font-bold text-center mb-2 text-white">Welcome to <span class="text-indigo-400">RaVa</span> AI</h1>
                <p class="text-center text-slate-400 mb-8">Sign in to continue</p>
                <div id="email-password-form">
                    <input id="email-input" type="email" placeholder="Email" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 mb-4 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input id="password-input" type="password" placeholder="Password" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 mb-4 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <div id="auth-error" class="text-red-400 text-sm mb-4 hidden"></div>
                    <button id="login-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition duration-300">Login</button>
                    <button id="signup-btn" class="w-full mt-3 bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-lg transition duration-300">Sign Up</button>
                </div>
                <div class="relative flex py-5 items-center">
                    <div class="flex-grow border-t border-slate-600"></div><span class="flex-shrink mx-4 text-slate-400">OR</span><div class="flex-grow border-t border-slate-600"></div>
                </div>
                <button id="google-signin-btn" class="w-full flex items-center justify-center bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 border border-slate-600">
                    <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.012 36.49 44 30.863 44 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                    Continue with Google
                </button>
            </div>
        </div>

        <div id="pricing-view" class="w-full h-full flex items-center justify-center hidden p-4">
             <div class="w-full max-w-4xl bg-slate-900/50 backdrop-blur-xl border border-indigo-500/50 rounded-2xl p-6 sm:p-8 text-center shadow-2xl shadow-indigo-500/20">
                <h2 class="text-3xl font-bold text-white mb-4">Unlock Full Potential</h2>
                <p class="text-slate-300 mb-8">Choose a plan to get unlimited access.</p>
                <div class="flex flex-col sm:flex-row gap-8">
                    <div class="bg-slate-800/60 p-8 rounded-xl border border-slate-700 flex-1">
                        <h3 class="text-2xl font-semibold text-white mb-2">Monthly</h3>
                        <p class="text-4xl font-bold text-indigo-400 mb-4">₹250</p>
                        <button onclick="handlePurchaseClick()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition duration-300">Contact Admin</button>
                    </div>
                    <div class="relative bg-slate-800/60 p-8 rounded-xl border border-sky-500 flex-1">
                         <span class="absolute top-0 right-0 -mt-3 mr-3 px-3 py-1 text-sm font-bold text-white bg-sky-500 rounded-full">BEST VALUE</span>
                        <h3 class="text-2xl font-semibold text-white mb-2">Yearly</h3>
                        <p class="text-4xl font-bold text-sky-400 mb-4">₹350</p>
                        <button onclick="handlePurchaseClick()" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 rounded-lg transition duration-300">Contact Admin</button>
                    </div>
                </div>
                 <button id="back-to-chat-btn" class="mt-8 text-slate-400 hover:text-white">Back to Chat</button>
            </div>
        </div>

        <div id="app-view" class="w-full max-w-5xl flex-col flex bg-blurry sm:rounded-2xl border-t sm:border border-slate-700/50 shadow-2xl shadow-black/50 overflow-hidden">
             <header class="flex justify-between items-center gap-y-2 p-3 border-b border-slate-700 flex-shrink-0">
                <div class="text-left">
                    <h1 class="text-lg font-bold text-white">RaVa <span class="text-indigo-400">AI</span></h1>
                    <p class="text-xs text-slate-500 -mt-1 hidden sm:block">By Vishal Goswami</p>
                </div>
                <div class="flex items-center bg-slate-800 p-1 rounded-lg">
                    <button id="chat-mode-btn" class="px-3 py-1 text-sm font-semibold rounded-md bg-indigo-600 text-white flex-1 whitespace-nowrap">Chat</button>
                    <button id="image-mode-btn" class="px-3 py-1 text-sm font-semibold rounded-md text-slate-300 flex-1 whitespace-nowrap">Image Gen</button>
                </div>
                 <div id="user-info" class="hidden items-center space-x-4">
                    <button id="logout-btn" class="bg-slate-700 hover:bg-red-600 p-2 rounded-full text-white font-semibold transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    </button>
                </div>
            </header>
            <main class="flex-1 flex flex-col p-2 sm:p-4 overflow-hidden">
                <div id="chat-container" class="flex-1 overflow-y-auto pr-2">
                    <div class="flex items-start gap-3 mb-6 chat-message">
                        <div class="bg-slate-700 p-2 rounded-full flex-shrink-0">
                            <svg class="w-6 h-6 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M12 6V4m0 16v-2M8 12a4 4 0 118 0 4 4 0 01-8 0z"></path></svg>
                        </div>
                        <div>
                            <p class="font-bold text-indigo-400">RaVa</p>
                            <div id="ai-greeting" class="text-white mt-1">Hello! How can I assist you today?</div>
                        </div>
                    </div>
                </div>
                <div class="mt-2 sm:mt-4 pt-2 sm:pt-4 border-t border-slate-700 flex-shrink-0">
                    <div id="guest-info" class="flex items-center justify-center gap-x-4 mb-3">
                        <button id="login-prompt-btn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 px-3 py-2 text-sm sm:text-base rounded-lg text-white font-semibold transition whitespace-nowrap">Login / Sign Up</button>
                        <button id="pricing-btn" class="flex-1 bg-slate-700 hover:bg-indigo-600 px-3 py-2 text-sm sm:text-base rounded-lg text-white font-semibold transition">Pricing</button>
                    </div>
                    <div class="bg-slate-800 rounded-xl flex items-center glowing-border">
                        <textarea id="prompt-input" rows="1" placeholder="Ask RaVa AI anything..." class="w-full bg-transparent p-4 pr-24 sm:pr-28 text-white focus:outline-none resize-none"></textarea>
                        <div class="absolute right-1 sm:right-2 top-1/2 -translate-y-1/2 flex items-center">
                             <input type="file" id="image-upload" class="hidden" accept="image/*">
                             <button id="image-upload-btn" title="Upload Image" class="p-2 rounded-full hover:bg-slate-700 text-slate-400 hover:text-white">
                                <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                             </button>
                             <button id="send-btn" class="p-2 rounded-full bg-indigo-600 text-white hover:bg-indigo-700 disabled:bg-slate-500">
                                 <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" transform="rotate(90)"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                             </button>
                        </div>
                    </div>
                    <div id="image-preview-container" class="mt-2 hidden">
                        <img id="image-preview" src="" class="max-h-24 rounded-lg">
                        <button id="remove-image-btn" class="text-xs text-red-400 hover:underline">Remove</button>
                    </div>
                </div>
            </main>
        </div>

        <div id="admin-view-container" class="w-full max-w-5xl flex-col flex bg-blurry sm:rounded-2xl border-t sm:border border-slate-700/50 shadow-2xl shadow-black/50 overflow-hidden hidden">
            <div id="admin-login-form" class="w-full h-full flex items-center justify-center p-4">
                 <div class="w-full max-w-sm bg-gray-900/50 backdrop-blur-xl border border-blue-500/50 rounded-2xl p-8 shadow-2xl shadow-blue-500/20">
                     <h2 class="text-2xl font-bold text-center text-white mb-6">Admin Panel Login</h2>
                     <input id="admin-pass" type="password" placeholder="Admin Password" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 mb-4 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                     <div id="admin-auth-error" class="text-red-400 text-sm mb-4 hidden"></div>
                     <button id="admin-login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition">Login</button>
                </div>
            </div>
            <div id="admin-dashboard" class="hidden w-full h-full flex flex-col">
                 <header class="p-4 border-b border-slate-700 flex-shrink-0"><h2 class="text-2xl font-bold text-white">Admin Dashboard</h2></header>
                 <div class="flex-1 grid grid-cols-1 lg:grid-cols-1 gap-8 p-6 overflow-y-auto">
                    <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-700">
                        <h3 class="text-xl font-semibold mb-4 text-white">User Management</h3>
                        <div id="user-list" class="space-y-2"></div>
                    </div>
                 </div>
            </div>
        </div>
        
    </div>

    <script type="module">
        // BRO, YEH ERROR (auth/api-key-not-valid) TAB AATA HAI JAB NETLIFY MEIN
        // VITE_FIREBASE_API_KEY GALAT HOTI HAI.
        // PLEASE NETLIFY DASHBOARD MEIN JAO -> SITE SETTINGS -> BUILD & DEPLOY -> ENVIRONMENT
        // AUR CHECK KARO KI AAPNE API KEY BILKUL SAHI PASTE KI HAI, BINA KISI EXTRA SPACE KE.
        const firebaseConfig = {
          apiKey: "%VITE_FIREBASE_API_KEY%",
          authDomain: "%VITE_FIREBASE_AUTH_DOMAIN%",
          projectId: "%VITE_FIREBASE_PROJECT_ID%",
          storageBucket: "%VITE_FIREBASE_STORAGE_BUCKET%",
          messagingSenderId: "%VITE_FIREBASE_MESSAGING_SENDER_ID%",
          appId: "%VITE_FIREBASE_APP_ID%",
          measurementId: "%VITE_FIREBASE_MEASUREMENT_ID%"
        };
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { marked } from "https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        const appId = 'rava-ai-app';

        const [loginView, pricingView, appView, adminViewContainer, adminLoginForm, adminDashboard, userInfo, guestInfo, promptInput, chatModeBtn, imageModeBtn, imageUploadBtn, pricingBtn, loginPromptBtn, sendBtn, chatContainer] = 
            ['login-view', 'pricing-view', 'app-view', 'admin-view-container', 'admin-login-form', 'admin-dashboard', 'user-info', 'guest-info', 'prompt-input', 'chat-mode-btn', 'image-mode-btn', 'image-upload-btn', 'pricing-btn', 'login-prompt-btn', 'send-btn', 'chat-container'].map(id => document.getElementById(id));
        
        let currentUser = null, imageBase64 = null, currentMode = 'chat';
        let userStatus = 'guest';

        function createStars() {
            const canvas = document.getElementById('space-bg');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            let stars = [];
            for (let i = 0; i < 400; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    radius: Math.random() * 1.5,
                    vx: (Math.random() - 0.5) * 0.5,
                    vy: (Math.random() - 0.5) * 0.5
                });
            }
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.globalCompositeOperation = "lighter";
                for (let i = 0; i < stars.length; i++) {
                    let s = stars[i];
                    ctx.fillStyle = "#fff";
                    ctx.beginPath();
                    ctx.arc(s.x, s.y, s.radius, 0, 2 * Math.PI);
                    ctx.fill();
                }
            }
            function update() {
                for (let i = 0; i < stars.length; i++) {
                    let s = stars[i];
                    s.x += s.vx;
                    s.y += s.vy;
                    if (s.x < 0 || s.x > canvas.width) s.x = s.x < 0 ? canvas.width : 0;
                    if (s.y < 0 || s.y > canvas.height) s.y = s.y < 0 ? canvas.height : 0;
                }
            }
            function tick() {
                draw();
                update();
                requestAnimationFrame(tick);
            }
            tick();
        }

        function showView(viewName) {
            [loginView, pricingView, appView, adminViewContainer].forEach(v => v.classList.add('hidden'));
            document.getElementById('app-root').classList.toggle('sm:p-4', ['login', 'pricing'].includes(viewName));
            const viewId = viewName === 'admin' ? 'admin-view-container' : `${viewName}-view`;
            document.getElementById(viewId).classList.remove('hidden');
        }

        onAuthStateChanged(auth, async (user) => {
            const path = window.location.pathname;
            if (path.includes('/random') || path.includes('/admin')) return showView('admin');

            if (user && !user.isAnonymous) {
                currentUser = user; userInfo.classList.remove('hidden'); guestInfo.classList.add('hidden');
                const userRef = doc(db, `artifacts/${appId}/users`, user.uid);
                let userDoc = await getDoc(userRef);
                if (!userDoc.exists()) {
                    await setDoc(userRef, { email: user.email, userId: createRandomId(), createdAt: serverTimestamp(), accessGranted: false, banned: false });
                    userDoc = await getDoc(userRef);
                }
                const userData = userDoc.data();
                if (userData.banned) { alert("Your account has been banned."); return signOut(auth); }
                const isTrialExpired = userData.createdAt ? (Date.now() - userData.createdAt.toDate().getTime()) > (7 * 24 * 60 * 60 * 1000) : true;
                if (!userData.accessGranted && isTrialExpired) return showView('pricing');
                if (location.hash !== '#pricing') showView('app');
            } else {
                currentUser = auth.currentUser; userInfo.classList.add('hidden'); guestInfo.classList.remove('hidden');
                userStatus = 'guest';
                if (!currentUser) signInAnonymously(auth).catch(e => console.error("Anonymous sign-in failed:", e));
                if (location.hash !== '#pricing') showView('app');
            }
        });

        function setupAuthListeners() {
            document.getElementById('google-signin-btn').addEventListener('click', () => signInWithPopup(auth, provider).catch(handleAuthError));
            document.getElementById('login-btn').addEventListener('click', () => signInWithEmailAndPassword(auth, document.getElementById('email-input').value, document.getElementById('password-input').value).catch(handleAuthError));
            document.getElementById('signup-btn').addEventListener('click', () => createUserWithEmailAndPassword(auth, document.getElementById('email-input').value, document.getElementById('password-input').value).catch(handleAuthError));
            loginPromptBtn.addEventListener('click', () => showView('login'));
            pricingBtn.addEventListener('click', () => { location.hash = '#pricing'; showView('pricing'); });
            document.getElementById('back-to-chat-btn').addEventListener('click', () => { location.hash = ''; showView('app'); });
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
        }

        function handleAuthError(error) {
            const errorDiv = document.getElementById('auth-error');
            errorDiv.textContent = error.message.replace('Firebase: ', '');
            errorDiv.classList.remove('hidden');
        }

        function switchMode(mode) {
            currentMode = mode;
            chatModeBtn.classList.toggle('bg-indigo-600', mode === 'chat'); chatModeBtn.classList.toggle('text-white', mode === 'chat');
            imageModeBtn.classList.toggle('bg-indigo-600', mode === 'image'); imageModeBtn.classList.toggle('text-white', mode === 'image');
            promptInput.placeholder = mode === 'chat' ? "Ask RaVa anything..." : "Describe an image to create or style...";
        }
        chatModeBtn.addEventListener('click', () => switchMode('chat')); imageModeBtn.addEventListener('click', () => switchMode('image'));
        
        sendBtn.addEventListener('click', handleSendMessage); promptInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } });
        
        async function handleSendMessage() {
            const prompt = promptInput.value.trim(); if (!prompt && !imageBase64) return;
            sendBtn.disabled = true; addUserMessage(prompt, imageBase64); promptInput.value = '';
            addBotMessage("", true);
            try {
                const response = await callProxyAPI(prompt, imageBase64, currentMode, userStatus);
                const part = response?.candidates?.[0]?.content?.parts?.[0];
                if (!part) throw new Error("Invalid response structure from API.");

                const responseText = part.text;
                if (responseText) {
                    if (responseText.includes('Welcome back, Master!')) userStatus = 'master'; 
                    else if (responseText.includes("Welcome! It's so good to hear from you.")) userStatus = 'family';
                }
                
                const b64 = part.inlineData?.data;
                if (b64) {
                    updateBotMessageWithImage(b64, prompt);
                } else {
                    updateBotMessage(responseText || "I'm not sure how to respond to that, try something else.");
                }

            } catch (error) { console.error("Full API Error:", error); updateBotMessage(`Sorry, an error occurred: **Details:** ${error.message}`); } 
            finally { sendBtn.disabled = false; removeImage(); }
        }

        async function callProxyAPI(prompt, base64Data, mode, status) {
            const response = await fetch('/.netlify/functions/gemini', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt, base64Data, mode, userStatus: status }) });
            const result = await response.json();
            if (!response.ok) throw new Error(JSON.stringify(result.error) || 'Unknown error');
            return result;
        }

        function addUserMessage(text, b64) {
            let imageHtml = b64 ? `<img src="data:image/jpeg;base64,${b64}" class="rounded-lg max-w-xs mt-2">` : '';
            const messageHtml = `<div class="flex items-start gap-3 mb-6 justify-end chat-message"><div class="max-w-[80%]"><p class="font-bold text-right text-indigo-300">You</p><div class="bg-indigo-900/50 backdrop-blur-sm p-3 rounded-lg mt-1 text-white break-words">${text} ${imageHtml}</div></div><div class="bg-slate-700 p-2 rounded-full flex-shrink-0"><svg class="w-6 h-6 text-indigo-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></div></div>`;
            chatContainer.insertAdjacentHTML('beforeend', messageHtml); chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addBotMessage(text, isTyping = false) {
            let contentHtml = text;
            if (isTyping) {
                contentHtml = `<div class="thinking-box"><div class="thinking-box-content text-center text-slate-300">RaVa is thinking...</div></div>`;
            }
            const messageHtml = `<div class="flex items-start gap-3 mb-6 ai-message ${isTyping ? 'typing-indicator' : ''} chat-message"><div class="bg-slate-700 p-2 rounded-full flex-shrink-0"><svg class="w-6 h-6 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M12 6V4m0 16v-2M8 12a4 4 0 118 0 4 4 0 01-8 0z"></path></svg></div><div class="max-w-[80%]"><p class="font-bold text-indigo-400">RaVa</p><div class="text-white mt-1 ai-message-content break-words">${contentHtml}</div></div></div>`;
            chatContainer.insertAdjacentHTML('beforeend', messageHtml); chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function updateBotMessage(text) {
            const typingIndicator = chatContainer.querySelector('.typing-indicator .ai-message-content');
            if (typingIndicator) { typingIndicator.innerHTML = marked.parse(text); typingIndicator.closest('.typing-indicator').classList.remove('typing-indicator'); }
        }

        function updateBotMessageWithImage(base64Image, prompt) {
            const typingIndicator = chatContainer.querySelector('.typing-indicator .ai-message-content');
            if (typingIndicator) { 
                const imageName = prompt.replace(/\s+/g, '_').slice(0, 20) || 'rava-image';
                typingIndicator.innerHTML = `
                    <div class="p-2 bg-black/20 rounded-lg">
                        <img src="data:image/png;base64,${base64Image}" class="rounded-lg max-w-full">
                        <button onclick="downloadImage('data:image/png;base64,${base64Image}', '${imageName}.png')" class="mt-2 w-full text-center bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition text-sm">Download Image</button>
                    </div>`; 
                typingIndicator.closest('.typing-indicator').classList.remove('typing-indicator'); 
            }
        }
        
        window.downloadImage = (dataUrl, filename) => {
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = filename;
            link.click();
        }

        const imageUpload = document.getElementById('image-upload');
        imageUploadBtn.addEventListener('click', () => imageUpload.click());
        document.getElementById('remove-image-btn').addEventListener('click', removeImage);
        imageUpload.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (event) => { imageBase64 = event.target.result.replace('data:', '').replace(/^.+,/, ''); document.getElementById('image-preview').src = event.target.result; document.getElementById('image-preview-container').classList.remove('hidden'); }; reader.readAsDataURL(file); } });
        function removeImage() { imageBase64 = null; imageUpload.value = ''; document.getElementById('image-preview-container').classList.add('hidden'); }
        
        document.getElementById('admin-login-btn').addEventListener('click', () => {
            if (document.getElementById('admin-pass').value === 'MasterVishal@Rava') {
                adminLoginForm.classList.add('hidden'); adminDashboard.classList.remove('hidden'); loadUsers();
            } else { document.getElementById('admin-auth-error').textContent = 'Invalid Password.'; document.getElementById('admin-auth-error').classList.remove('hidden'); }
        });
        
        async function loadUsers() {
            const userListDiv = document.getElementById('user-list');
            userListDiv.innerHTML = '<p class="text-gray-400">Loading users...</p>';
            const querySnapshot = await getDocs(collection(db, `artifacts/${appId}/users`));
            userListDiv.innerHTML = querySnapshot.docs.map(doc => { const user = doc.data(); return `<div class="flex justify-between items-center p-3 bg-gray-800 rounded-lg"><div><p class="text-white font-semibold">${user.email || 'Anonymous'}</p><p class="text-xs text-gray-400 font-mono">${doc.id}</p><p class="text-xs ${user.accessGranted ? 'text-green-400' : 'text-yellow-400'}">${user.accessGranted ? 'Access Granted' : 'Trial/Expired'}</p></div><div class="flex gap-2"><button onclick="window.grantUserAccess('${doc.id}')" class="text-xs bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-md">Grant</button><button onclick="window.banUser('${doc.id}', ${!user.banned})" class="text-xs ${user.banned ? 'bg-yellow-500' : 'bg-red-600'} hover:bg-red-700 text-white px-3 py-1 rounded-md">${user.banned ? 'Unban' : 'Ban'}</button></div></div>`; }).join('');
        }

        window.grantUserAccess = async (uid) => { if (confirm('Are you sure?')) { await updateDoc(doc(db, `artifacts/${appId}/users`, uid), { accessGranted: true }); loadUsers(); } };
        window.banUser = async (uid, shouldBan) => { if (confirm(`Are you sure?`)) { await updateDoc(doc(db, `artifacts/${appId}/users`, uid), { banned: shouldBan }); loadUsers(); } };
        window.handlePurchaseClick = () => { if (currentUser && !currentUser.isAnonymous) showContactModal(); else { alert('Please log in first.'); showView('login'); } }
        const createRandomId = () => Math.random().toString(36).substring(2, 15);
        
        function init() {
            const path = window.location.pathname;
            if (path.includes('/random') || path.includes('/admin')) { showView('admin'); } 
            else { showView('app'); document.getElementById('ai-greeting').textContent = ["Hi, what's up?", "What can I help you with today?"][Math.floor(Math.random() * 2)]; createStars(); }
            setupAuthListeners();
        }
        init();
    </script>
</body>
</html>

